#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

branch=$(git rev-parse --abbrev-ref HEAD)

# Block direct pushes to protected branches
if [ "$branch" = "master" ] || [ "$branch" = "main" ]; then
  echo "âŒ Direct push to $branch is blocked. Create a feature branch and open a PR."
  exit 1
fi

if [ "$branch" = "PROD" ]; then
  echo "âŒ Direct push to PROD is strictly prohibited!"
  echo "âš ï¸  PROD branch is protected and requires:"
  echo "   â€¢ Pull Request with review"
  echo "   â€¢ Security audit passing"
  echo "   â€¢ All CI checks passing"
  echo ""
  echo "ğŸ“‹ To deploy to PROD:"
  echo "   1. Create PR from master to PROD"
  echo "   2. Ensure all checks pass"
  echo "   3. Get approval"
  echo "   4. Merge via GitHub"
  exit 1
fi

# Run security checks if pushing to any branch (catches issues early)
echo "ğŸ” Running security checks..."

# Check for vulnerabilities
echo "ğŸ“¦ Checking for vulnerable dependencies..."
if ! pnpm audit --audit-level=moderate; then
  echo ""
  echo "âŒ Security vulnerabilities detected!"
  echo "âš ï¸  Run 'pnpm audit fix' to resolve issues"
  exit 1
fi

echo "âœ… Security checks passed!"
