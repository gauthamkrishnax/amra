name: ðŸ“ Auto Update PR Description

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  pull-requests: write
  contents: read

jobs:
  update-description:
    name: ðŸ“ Update PR Description
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“ Generate and update PR description
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;

            // Get the file changes
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });

            // Categorize files
            const categories = {
              frontend: [],
              styling: [],
              config: [],
              docs: [],
              dependencies: [],
              other: []
            };

            files.data.forEach(file => {
              const filename = file.filename;
              if (filename.startsWith('src/app/') || filename.startsWith('src/ui/')) {
                categories.frontend.push(file);
              } else if (filename.endsWith('.css') || filename.includes('tailwind') || filename.includes('postcss')) {
                categories.styling.push(file);
              } else if (filename.includes('.config.') || filename.includes('eslint') || filename.includes('prettier')) {
                categories.config.push(file);
              } else if (filename.endsWith('.md')) {
                categories.docs.push(file);
              } else if (filename === 'package.json' || filename === 'pnpm-lock.yaml') {
                categories.dependencies.push(file);
              } else {
                categories.other.push(file);
              }
            });

            // Calculate statistics
            const stats = {
              filesChanged: files.data.length,
              additions: pr.additions,
              deletions: pr.deletions,
              totalChanges: pr.additions + pr.deletions
            };

            // Build the auto-generated section
            let autoSection = '\n\n---\n## ðŸ¤– Auto-Generated PR Summary\n\n';

            // Statistics
            autoSection += '### ðŸ“Š Changes Overview\n\n';
            autoSection += `- **Files Changed:** ${stats.filesChanged}\n`;
            autoSection += `- **Lines Added:** +${stats.additions}\n`;
            autoSection += `- **Lines Deleted:** -${stats.deletions}\n`;
            autoSection += `- **Total Changes:** ${stats.totalChanges}\n\n`;

            // File breakdown by category
            autoSection += '### ðŸ“ Files Changed by Category\n\n';

            if (categories.frontend.length > 0) {
              autoSection += `#### ðŸ“± Frontend (${categories.frontend.length} files)\n`;
              categories.frontend.slice(0, 10).forEach(f => {
                autoSection += `- \`${f.filename}\` (+${f.additions}/-${f.deletions})\n`;
              });
              if (categories.frontend.length > 10) {
                autoSection += `- *...and ${categories.frontend.length - 10} more*\n`;
              }
              autoSection += '\n';
            }

            if (categories.styling.length > 0) {
              autoSection += `#### ðŸŽ¨ Styling (${categories.styling.length} files)\n`;
              categories.styling.forEach(f => {
                autoSection += `- \`${f.filename}\` (+${f.additions}/-${f.deletions})\n`;
              });
              autoSection += '\n';
            }

            if (categories.config.length > 0) {
              autoSection += `#### ðŸ”§ Configuration (${categories.config.length} files)\n`;
              categories.config.forEach(f => {
                autoSection += `- \`${f.filename}\` (+${f.additions}/-${f.deletions})\n`;
              });
              autoSection += '\n';
            }

            if (categories.dependencies.length > 0) {
              autoSection += `#### ðŸ“¦ Dependencies (${categories.dependencies.length} files)\n`;
              categories.dependencies.forEach(f => {
                autoSection += `- \`${f.filename}\` (+${f.additions}/-${f.deletions})\n`;
              });
              autoSection += '\n';
            }

            if (categories.docs.length > 0) {
              autoSection += `#### ðŸ“š Documentation (${categories.docs.length} files)\n`;
              categories.docs.forEach(f => {
                autoSection += `- \`${f.filename}\` (+${f.additions}/-${f.deletions})\n`;
              });
              autoSection += '\n';
            }

            if (categories.other.length > 0) {
              autoSection += `#### ðŸ“„ Other (${categories.other.length} files)\n`;
              categories.other.slice(0, 10).forEach(f => {
                autoSection += `- \`${f.filename}\` (+${f.additions}/-${f.deletions})\n`;
              });
              if (categories.other.length > 10) {
                autoSection += `- *...and ${categories.other.length - 10} more*\n`;
              }
              autoSection += '\n';
            }

            // Add helpful tips
            autoSection += '### âœ… Reviewer Checklist\n\n';
            autoSection += '- [ ] Code follows project conventions\n';
            autoSection += '- [ ] All CI checks pass\n';
            autoSection += '- [ ] No unintended changes included\n';
            autoSection += '- [ ] Changes are well-tested\n';
            if (categories.dependencies.length > 0) {
              autoSection += '- [ ] Dependencies are necessary and secure\n';
            }
            autoSection += '\n';

            autoSection += '*This section is auto-generated and updates with each push.*\n';

            // Get current description
            let currentBody = pr.body || '';

            // Remove old auto-generated section if exists
            const autoSectionMarker = '---\n## ðŸ¤– Auto-Generated PR Summary';
            const markerIndex = currentBody.indexOf(autoSectionMarker);
            if (markerIndex !== -1) {
              currentBody = currentBody.substring(0, markerIndex).trim();
            }

            // Combine original description with auto-generated section
            const newBody = currentBody + autoSection;

            // Update PR description
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number,
              body: newBody
            });

            console.log('âœ… PR description updated successfully!');
